name: Deploy Documentation

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

permissions:
  contents: read
  pages: write
  id-token: write

concurrency:
  group: "pages"
  cancel-in-progress: false

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout
      uses: actions/checkout@v4

    - name: Setup Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -e .
        pip install jupyter nbconvert

    - name: Setup Pages
      uses: actions/configure-pages@v4

    - name: Create docs directory structure
      run: |
        mkdir -p _site
        mkdir -p _site/docs
        mkdir -p _site/docs/tutorials
        mkdir -p _site/examples

    - name: Copy documentation files
      run: |
        # Copy main documentation
        cp README.md _site/index.md
        cp docs/*.md _site/docs/
        
        # Copy tutorials
        cp docs/tutorials/*.md _site/docs/tutorials/ || true
        
        # Convert Jupyter notebooks to HTML (with error handling)
        if [ -f "docs/tutorials/getting_started.ipynb" ] && [ -s "docs/tutorials/getting_started.ipynb" ]; then
          echo "Converting getting_started.ipynb..."
          jupyter nbconvert --to html docs/tutorials/getting_started.ipynb --output-dir _site/docs/tutorials/ --template basic || echo "Failed to convert getting_started.ipynb"
        else
          echo "Skipping getting_started.ipynb (empty or missing)"
        fi
        
        if [ -f "docs/tutorials/gsa_comprehensive.ipynb" ] && [ -s "docs/tutorials/gsa_comprehensive.ipynb" ]; then
          echo "Converting gsa_comprehensive.ipynb..."
          jupyter nbconvert --to html docs/tutorials/gsa_comprehensive.ipynb --output-dir _site/docs/tutorials/ --template basic || echo "Failed to convert gsa_comprehensive.ipynb"
        else
          echo "Skipping gsa_comprehensive.ipynb (empty or missing)"
        fi
        
        # Copy examples
        cp examples/*.py _site/examples/

    - name: Create navigation structure
      run: |
        cat > _site/_config.yml << 'EOF'
        title: MCPost Documentation
        description: Monte Carlo Post-analysis Package
        theme: minima
        
        plugins:
          - jekyll-relative-links
        
        relative_links:
          enabled: true
          collections: true
        
        include:
          - README.md
        
        markdown: kramdown
        highlighter: rouge
        
        navigation:
          - title: Home
            url: /
          - title: Documentation
            url: /docs/
          - title: Tutorials
            url: /docs/tutorials/
          - title: Examples
            url: /examples/
        EOF

    - name: Create index page
      run: |
        cat > _site/index.md << 'EOF'
        ---
        layout: default
        title: MCPost Documentation
        ---
        
        # MCPost: Monte Carlo Post-analysis Package
        
        Welcome to the MCPost documentation! MCPost is a comprehensive Python package for post-analysis of Monte Carlo samples, providing tools for global sensitivity analysis (GSA) and Monte Carlo integration.
        
        ## Quick Navigation
        
        - **[Getting Started](docs/tutorials/getting_started.html)** - Your first MCPost analysis
        - **[GSA Tutorial](docs/tutorials/gsa_comprehensive.html)** - Advanced sensitivity analysis
        - **[Extension Guide](docs/extension_guide.html)** - Creating custom methods
        
        ## Documentation
        
        - [Extension Guide](docs/extension_guide.html)
        
        ## Examples
        
        - [Climate Sensitivity Analysis](examples/climate_sensitivity.py)
        - [Financial Risk Analysis](examples/financial_risk.py)
        - [Integration Comparison](examples/integration_comparison.py)
        
        ## Installation
        
        ```bash
        pip install MC-post
        ```
        
        For development:
        
        ```bash
        git clone https://github.com/zzhang0123/mcpost.git
        cd mcpost
        pip install -e .[dev]
        ```
        
        ## Repository
        
        Visit the [GitHub repository](https://github.com/zzhang0123/mcpost) for source code, issues, and contributions.
        EOF

    - name: Build with Jekyll
      uses: actions/jekyll-build-pages@v1
      with:
        source: ./_site
        destination: ./_build

    - name: Upload artifact
      uses: actions/upload-pages-artifact@v3
      with:
        path: ./_build

  deploy:
    if: github.ref == 'refs/heads/main'
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    runs-on: ubuntu-latest
    needs: build
    steps:
      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4